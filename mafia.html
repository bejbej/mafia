<!DOCTYPE html>
<html>
<head>
	<title>Mafia</title>
	<link rel='stylesheet' type='text/css' href='./css/bootstrap.min.css' />
	<style>
		body{
			font-family:sans-serif;
			padding-top: 70px;
		}
		.heading{
			font-size:2em;
		}
		#game-table {
			width:100%;
			table-layout: fixed;
			overflow:hidden;
		}
		#game-table tbody tr td{
			cursor:pointer;
			overflow:hidden;
		}
		.almost-dead{
			color:orange;
			text-decoration: line-through;
		}
		.dead{
			color: gainsboro;
			text-decoration: line-through;
		}
	</style>
</head>
<body>
	<div id='setup-page' class='page'>
		<div class='navbar navbar-fixed-top navbar-inverse'>
				<div class='container'>
					<div class="btn-group">
						<button onclick='ShowSetupPage()' class='btn btn-primary navbar-btn active'><span class="glyphicon glyphicon-cog"></span></button>
						<button onclick='ShowPlayPage()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-user"></span></button>
						<button onclick='ShowCardPage()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-picture"></span></button>
					</div>
				</div>
		</div>
		<div class='container'>
			<div id='section-players'>
				<div class='input-group'><span class='input-group-addon'>Players</span><input type='text' id='number-of-players' class='form-control disabled' value='0'></div>
				<br>
				<div class='input-group'><span class='input-group-addon'>Civilians</span><input type='text' id='number-of-civilians' class='form-control' value='0'></div>
				<br>
				<div class='input-group'><span class='input-group-addon'>Mafia</span><input type='text' id='number-of-mafia' class='form-control' value='0'></div>
			</div>
				<div class='row'>
					<div class='col-md-6'>
						<h3>Civilian Professions <span id='civilian-profession-count'></span></h3>
						<div id='civilian-list'></div>
						<h3>Mafia Professions <span id='mafia-profession-count'></span></h3>
						<div id='mafia-list'></div>
					</div>
				<div class='col-md-6'>
					<h3>Traits <span id='trait-count'></span></h3>
					<div id='trait-list'></div>
				</div>
			</div>
		</div>
	</div>
	<div id='play-page' class='page' style='display:none'>
		<div class='navbar navbar-fixed-top navbar-inverse'>
			<div class='container'>
					<div class="btn-group">
						<button onclick='ShowSetupPage()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-cog"></span></button>
						<button onclick='ShowPlayPage()' class='btn btn-primary navbar-btn active'><span class="glyphicon glyphicon-user"></span></button>
						<button onclick='ShowCardPage()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-picture"></span></button>
					</div>
					<div class='pull-right'>
						<button onclick='GenerateGame()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-random"></span></button>
					</div>
			</div>
		</div>
		<div class='container'>
			<table id='game-table' class='table'>
				<tr>
					<th>Name</th>
					<th>Profession</th>
					<th>Trait</th>
				</tr>
			</table>
		</div>
	</div>
	<div id='card-page' class='page' style='display:none'>
		<div class='navbar navbar-fixed-top navbar-inverse'>
			<div class='container'>
					<div class="btn-group">
						<button onclick='ShowSetupPage()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-cog"></span></button>
						<button onclick='ShowPlayPage()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-user"></span></button>
						<button onclick='ShowCardPage()' class='btn btn-primary navbar-btn active'><span class="glyphicon glyphicon-picture"></span></button>
					</div>			<div class='pull-right'>
					<button onclick='PreviousCard()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-arrow-left"></span></button>
					<button onclick='NextCard()' class='btn btn-primary navbar-btn'><span class="glyphicon glyphicon-arrow-right"></span></button>
				</div>
			</div>
		</div>
		<div id='card' class='text-center' data-card='0'>
			<h1>James</h1>
			<h1>Sheriff</h1>
			<h1>Magician</h1>
		</div>
	</div>
</body>
<script src='./js/jquery-1.10.2.min.js'></script>
<script src='./js/bootstrap.min.js'></script>
<script type='text/javascript'>

	var input_players;
	var input_civilians;
	var input_mafia;
	var players;
	var civilians;
	var mafia;
	var civilian_professions;
	var mafia_professions;
	var traits;
	
	$(document).ready(init());

	function init () {
		input_players        = $('#number-of-players');
		input_civilians      = $('#number-of-civilians');
		input_mafia          = $('#number-of-mafia');
		AddCivilian(['Bodyguard','Doctor','Nurse','Reporter','Sheriff']);
		AddMafia(['Escort','Thief','Spy','Mob Boss']);
		AddTraits(['Alien','Assassin','Bus Driver','Mad Scientist','Witch','Idiot','Judge','Female Lover','Male Lover','Magician','Mute','Slow Plague','Fast Plague','Procrastinator','stalker','Zombie']);
	};

	function ShowSetupPage () {
		$('.page').hide();
		$('#setup-page').show();
	}
	
	function ShowPlayPage () {
		if ($('.view-name').size() == 0) {
			GenerateGame();
		}
		$('.page').hide();
		$('#play-page').show();
	};

	function ShowCardPage () {
		$('#card').data('card', 0);
		UpdateCard();
		$('.page').hide();
		$('#card-page').show();
	}
	
	function UpdateCount() {
		/* Updates the internal player counts based on the ui. */
		players              = +input_players.val();
		civilians            = +input_civilians.val();
		mafia                = +input_mafia.val();
		civilian_professions = $('.civilian:checked').size();
		mafia_professions    = $('.mafia:checked').size();
		traits               = $('.trait:checked').size();
	}

	function ApplyCount() {
		/* Applies the internal player counts to the ui */
		input_players.val(players);
		input_civilians.val(civilians);
		input_mafia.val(mafia);
	}

	function AddCivilian(array) {
		for (i=0; i<array.length; ++i) {
			AddCheckBoxTo($('#civilian-list'), 'civilian', array[i]);
		}
	}

	function AddMafia(array) {
		for (i=0; i<array.length; ++i) {
			AddCheckBoxTo($('#mafia-list'), 'mafia', array[i]);
		}
	}

	function AddTraits(array) {
		for (i=0; i<array.length; ++i) {
			AddCheckBoxTo($('#trait-list'), 'trait', array[i]);
		}
	}

	function AddCheckBoxTo(object, class_name, name) {
		object.append('<div class="checkbox"><label><input type="checkbox" class="'+class_name+'" name="'+name+'">'+name+'</label></div>')
	}

</script>
<script type='text/javascript'>

	$('#number-of-players').on('change', function() {
		UpdateCount();
		UpdateFromPlayers();
		ApplyCount();
	});

	$('#number-of-civilians').on('change', function() {
		UpdateCount();
		UpdateFromCivilians();
		ApplyCount();
	});

	$('#number-of-mafia').on('change', function() {
		UpdateCount();
		UpdateFromMafia();
		ApplyCount();
	})

	$('.civilian').on('change', function() {
		UpdateCount();
		text = civilian_professions == 0?'':'('+civilian_professions+')';
		$('#civilian-profession-count').text(text);
		if ($(this).is(":checked") && civilians < civilian_professions) {
			civilians = civilian_professions;
			UpdateFromCivilians();
			ApplyCount();
		}
	});

	$('.mafia').on('change', function() {
		UpdateCount();
		text = mafia_professions == 0?'':'('+mafia_professions+')';
		$('#mafia-profession-count').text(text);
		if ($(this).is(':checked') && mafia < mafia_professions) {
			mafia = mafia_professions;
			UpdateFromMafia();
			ApplyCount();
		}
	});

	$('.trait').on('change', function() {
		UpdateCount();
		text = traits == 0?'':'('+traits+')';
		$('#trait-count').text(text);
		if ($(this).is(':checked') && players < traits) {
			players = traits;
			UpdateFromPlayers();
			ApplyCount();
		}
	});

	function UpdateFromPlayers() {
		if (players > civilians + mafia ) {
			civilians = players - mafia;
		} else {
			civilians = Math.max(players - mafia, civilian_professions, traits - mafia);
			mafia = Math.max(players - civilians, mafia_professions);
			players = Math.max(civilians + mafia, players, traits);
		}
	}

	function UpdateFromCivilians() {
		if (players < civilians + mafia ) {
			mafia = Math.max(players - civilians, mafia_professions);
			players = civilians + mafia;
		} else {
			civilians = Math.max(civilians, civilian_professions);
			mafia = players - civilians;
		}
	}

	function UpdateFromMafia() {
		if (players < civilians + mafia ) {
			civilians = Math.max(players - mafia, civilian_professions);
			players = civilians + mafia;
		} else {
			mafia = Math.max(mafia, mafia_professions);
			civilians = players - mafia;
		}
	}

</script>
<script type='text/javascript'>

	var profession_names = [];
	var trait_names = [];

	function GenerateGame() {
		UpdateCount();
		player_names = GetNames();
		profession_names = [];
		trait_names = [];
		mafia_names = ['Mafia'];
		$('.civilian:checked').each(function() {
			profession_names.push($(this).attr('name'));
		});
		for (i=profession_names.length; i<civilians; ++i) {
			profession_names.push('Civilian');
		}
		$('.mafia:checked').each(function() {
		    profession_names.push($(this).attr('name'));
				mafia_names.push($(this).attr('name'));
		});
		for (i=profession_names.length; i<players; ++i) {
			profession_names.push('Mafia');
		}
		$('.trait:checked').each(function() {
		    trait_names.push($(this).attr('name'));
		});
		for (i=trait_names.length; i<players; ++i) {
			trait_names.push('No Trait');
		}

		$('#game-table tr+tr').remove();

		profession_names = shuffle(profession_names);
		trait_names = shuffle(trait_names);
		for (i=0; i<players; ++i) {
			additional_class = '';
			if ($.inArray(profession_names[i], mafia_names) > -1)
				additional_class = 'danger';
			new_player = $('<tr class='+additional_class+'><td><span class=\'view-name\'>'+player_names[i]+'</span></td><td class=\'view-profession\'>'+profession_names[i]+'</td><td class=\'view-trait\'>'+trait_names[i]+'</td></tr>');
			object = new_player.appendTo('#game-table');
			AddEditable(object.find('.view-name'));
			AddStrikable(object.find('.view-profession,.view-trait'));
		}
	}

	function GetNames() {
		player_names = [];
		$('.view-name').each(function() {
			player_names.push($(this).text());
		});
		for (i=player_names.length; i<players; ++i) {
			player_names.push('player');
		}
		return player_names;
	}

	function shuffle(array) {
		for (i = array.length - 1; i > 0; --i) {
			var j = Math.floor(Math.random() * (i + 1));
			var temp = array[i];
			array[i] = array[j];
			array[j] = temp;
		}
		return array;
	}
	
	function AddStrikable(td) {
		td.on('click', function() {
			parent = $(this).parent();
			if (parent.hasClass('almost-dead')) {
				parent.removeClass('almost-dead');
				parent.addClass('dead');
			} else if ($(this).parent().hasClass('dead')) {
				parent.removeClass('dead');
			} else {
				parent.addClass('almost-dead');
			}
		});
	}
	
	function AddEditable(span) {
		span.on('click', function() {
			MakeEditable(span);
		});
	}
	
	function MakeEditable(span) {
		span.hide();
		span.parent().append('<input id="view-name-input" value='+span.text()+'>');
		$('#view-name-input').select();
		$('#view-name-input').on('focusout',function(){
			new_name = $(this).val();
			if (new_name != '') {
				$(this).parent().children(':first').text(new_name);
			}
			$(this).parent().children(':first').show();
			$(this).remove();
		});
	}
	
</script>
<script type='text/javascript'>
	function PreviousCard() {
		i = $('#card').data('card');
		i = i==0?profession_names.length-1:i-1;
		$('#card').data('card', i);
		UpdateCard();
	}

	function NextCard() {
		i = $('#card').data('card');
		i = i==profession_names.length-1?0:i+1;
		$('#card').data('card', i);
		UpdateCard();
	}

	function UpdateCard() {
		var player_names = GetNames();
		i = $('#card').data('card');
		$('#card').children().remove();
		if (player_names.length > 0) {
			$('#card').append('<h1>'+player_names[i]+'</h1>');
			$('#card').append('<h1>'+profession_names[i]+'</h1>');
			$('#card').append('<h1>'+trait_names[i]+'</h1>');
		}
	}
</script>
</html>
